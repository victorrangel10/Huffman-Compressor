#include <stdio.h>
#include <string.h>
#include "arvore.h"
#include "bitmap.h"
#include "listaArvores.h"
#define ASCII_SIZE 127
#define MEGABYTE 8388608

int eh_igual_codigo(char *codigo, char *string)
{
    if (strcmp(codigo, string) == 0)
    {
        return 1;
    }
    else
        return 0;
}

void LeString(char *frase, int pesos[ASCII_SIZE], lista *lista)
{
    char letra;
    for (int i = 0; frase[i] != '\0'; i++)
    {
        letra = frase[i];
        pesos[letra]++;
    }
}

void CriaArvoreOtima(lista *listaArvores)
{
    node *t1, *t2, *tr;
    while (RetornaTam(listaArvores) > 1)
    {
        tr = SomaDuasPrimeirasArvores(listaArvores, &t1, &t2);
        if (t1 && t2)
        {
            RetiraLista(listaArvores, t1);
            RetiraLista(listaArvores, t2);
            InsereFinalLista(listaArvores, tr);
        }
    }
}

void escreve_conteudo(bitmap *bm, FILE *arqtxt, int tam, char codigos[tam][tam], FILE *arqbin)
{
    int trocou = 0;
    int index = bitmapGetLength(bm), trocando = 0;
    char codigo[1000];
    int o = 0, z = 0;
    char caractere;

    while ((caractere = fgetc(arqtxt)) != EOF)
    {

        // escreve cada bit do codigo de um caracter no bitmap
        for (size_t j = 0; codigos[caractere][j] != '\0'; j++)
        {
            if (trocou)
            {
                trocou++;
                if (trocou >= 20)
                {
                    trocou = 0;
                }
            }
            if (bitmapGetLength(bm) > MEGABYTE - 20)
            {
                trocando = 1;
            }

            if (trocando || trocou)
            {
                printf("buscando o caracter '%c'\n", caractere);
            }

            bitmapAppendLeastSignificantBit(bm, (unsigned char)codigos[caractere][j]);
            // se chegar perto de do MB, dumpa e cria um novo

            if (trocando || trocou)
            {
                printf("Codigo atual eh: \n");
                for (size_t i = 0; i < j; i++)
                {
                    printf("%c", codigos[caractere][i]);
                }
                printf("\n");
            }
        }

        if (bitmapGetLength(bm) + 8 >= MEGABYTE)
        {
            fwrite(bitmapGetContents(bm), (bitmapGetLength(bm) + 7) / 8, 1, arqbin);
            bitmapLibera(bm);
            bm = bitmapInit(MEGABYTE);
            trocando = 0;
            trocou = 1;
        }
    }
}

void cria_array_pesos(int *pesos, FILE *arqtxt)
{
    int caractere;
    while ((caractere = fgetc(arqtxt)) != EOF)
    {
        pesos[caractere]++;
    }
}

int return_file_size(FILE *arq)
{
    fseek(arq, 0, SEEK_END);
    int size = ftell(arq);

    return size;
}

int main(int argc, char *argv[])
{
    /* char *frase = "joss conras dornie"; */

    // array de ints representando a tabela ASCII que contem os pesos de cada letra
    int pesos[ASCII_SIZE] = {0};

    lista *listaArvores = CriaLista();

    // arquivo de saida compactado
    FILE *arqbin = fopen("arquivos/compressao.comp", "wb");

    // arquivo de entrada
    FILE *arqtxt = fopen(argv[1], "r");

    if (arqtxt == NULL)
    {
        perror("Erro ao abrir arquivo txt");
        return EXIT_FAILURE;
    }

    if (arqbin == NULL)
    {
        perror("Erro ao abrir arquivo bin!");
        return EXIT_FAILURE;
    }

    long size;
    char codigoAtual[ASCII_SIZE];
    char codigos[ASCII_SIZE][ASCII_SIZE] = {0};

    // le o input e determina os pesos de cada letra
    cria_array_pesos(pesos, arqtxt);

    // Adiciona caracteres usados à lista de árvores
    for (size_t i = 0; i < ASCII_SIZE; i++)
    {
        if (pesos[i] > 0)
        {
            node *arvore = CriaArvore(i, pesos[i], CriaVazio(), CriaVazio());
            InsereFinalLista(listaArvores, arvore);
        }
    }

    // cria caractere ETX para comunicar o fim do texto
    node *arvore = CriaArvore(3, 1, CriaVazio(), CriaVazio());

    InsereFinalLista(listaArvores, arvore);

    OrdenaLista(listaArvores);

    CriaArvoreOtima(listaArvores);

    // gera os codigos binarios para cada caractere no texto
    GeraCodigos(ObtemPrimeiraArvore(listaArvores), codigoAtual, 0, ASCII_SIZE, codigos);

    // printa os codigos gerados
    printf("\n");
    for (int i = 0; i < ASCII_SIZE; i++)
    {
        if (codigos[i][0] != '\0')
        {
            printf("Caractere %c(%d): %s\n", i, i, codigos[i]);
        }
    }

    // escreve o conteudo compactado

    bitmap *bm = bitmapInit(MEGABYTE);

    // escrevre a arvore otima em formato binario no arquivo
    EscreveCabecalho(bm, ObtemPrimeiraArvore(listaArvores));

    rewind(arqtxt);

    escreve_conteudo(bm, arqtxt, ASCII_SIZE, codigos, arqbin);

    // coloca o caractere de final
    printf("COLOCANDO FINAL\n");
    for (size_t j = 0; codigos[03][j] != '\0'; j++)
    {
        printf("%c", (unsigned char)codigos[03][j]);
        bitmapAppendLeastSignificantBit(bm, (unsigned char)codigos[03][j]);
    }
    fwrite(bitmapGetContents(bm), (bitmapGetLength(bm) + 7) / 8, 1, arqbin);

    LiberaListaArvores(listaArvores);
    bitmapLibera(bm);
    fclose(arqbin);
    fclose(arqtxt);
    return EXIT_SUCCESS;
}
